<include file="public/header" title="登录"  body=""/>
<link rel="stylesheet" href="__STATIC__/css/sign_in.css"/>
<include file="public/header_nav" title="登录"  href="javascript:history.back(-1);"/>
    <!-- 头部模块 -->
    <div class="flool loginsignup2">
        <!--LOGO-->
        <img class="bg_1" src="__STATIC__/images/sign_in/pic-logo-bg.png" alt="LOGO"/>
        <!-- logo1 -->
        <div class="l_1">
            <img class="logo_1" src="{$tpshop_config.shop_info_wap_login_logo|default='__STATIC__/images/sign_in/logo_1.png'}" alt="">
        </div>
        <!-- 用户登录头像 -->
        <div style="display:none;" class="l_1">
            <img class="logo_2" src="__STATIC__/images/dynamic/dog_header.png" alt="">
            <span class="uers_name">用户ID</span>
        </div>
    </div>
    <div class="technological_process">
        <!-- 登录流程一 -->
        <div style="margin-top:1.92rem;" class="loginsingup-input">
            <!--登录表单-s-->
            <form  onsubmit="return false;"  method="post"  >
                <div class="content30">
                    <div class="lsu lsus">
                        <p></p>
                        <input type="text" name="username" id="username" value="" placeholder="请输入手机号"/>
                    </div>
                    <div class="lsu lsus">
                        <p style="background-position: 0 -1.70667rem;"></p>
                        <input style="padding-right: 3.584rem;" type="text" id="mobile_code" value="" name="mobile_code" placeholder="请输入短信验证码" >
                        <input class="cold_1" onClick="sendcode(this)" type="button" value="获取验证码">
                        <input type="hidden" name="referurl" id="referurl" value="{$referurl}">
                    </div>
                    <div class="lsu submit">
                        <input type="button"  value="登录"  onclick="submitverify()" class="btn_big1"  />
                        <input type="hidden" name="referurl" id="referurl" value="{$referurl}">
                    </div>
                    <div class="signup-find p">
                        <div class="note fl">
                            <a href="{:U('Mobile/User/reg')}"><span>快速注册</span></a>
                        </div>
                        <div class="note fr">
                            <a class="sign_password" href="javascript:;"><span>账号密码登录</span></a>
                        </div>
                    </div>
                </div>
            </form>
            <!--登录表单-e-->
        </div>
        <!-- 登录流程二 -->
        <div style="margin-top: 0.490667rem;display:none;" class="loginsingup-input">
            <!--登录表单-s-->
            <form  onsubmit="return false;"  method="post"  >
                <div class="content30">
                    <div class="lsu lsus">
                        <p></p>
                        <input type="text" name="username" id="username_2" value=""  placeholder="请输入账号/手机号"/>
                    </div>
                    <div class="lsu lsus">
                        <p style="background-position: 0 -0.8533rem;"></p>
                        <input style="padding-right: 3.8rem;" type="password" name="password" id="password" value="" placeholder="请输入密码"/>
                        <i class="eye"></i>
                        <a href="{:U('Mobile/User/forget_pwd')}" class="ya_mima"><b></b> 忘记密码</a>
                    </div>

                    <div class="lsu test lsus">
                        <p style="background-position: 0 -1.70667rem;"></p>
                        <input style="padding-right: 3.584rem;" type="text" name="verify_code" id="verify_code_2" value="" placeholder="验证码"/>
                        <!--判断是否第一次登录，是否需要获取验证码-->
                        <input type="hidden" id="is_first" value="1"/>
                        <img  id="verify_code_img" src="{:U('Mobile/User/verify')}" onClick="verify()"/>
                    </div>

                    <div class="lsu submit">
                        <input type="button"  value="登录"  onclick="submitverify2()" class="btn_big1"  />
                        <input type="hidden" name="referurl" id="referurl" value="{$referurl}">
                    </div>
                    <!-- <div class="radio">
                        <lable>
                        <span class="che check_t" onclick="remember(this)">
                            <i><input type="checkbox" name="remember" value="1" checked="" style="display: none"> </i>
                            <span>自动登录</span>
                        </span>
                        </lable>
                    </div> -->
                    <div class="signup-find p">
                        <div class="note fl">
                            <a href="{:U('Mobile/User/reg')}"><span>快速注册</span></a>
                        </div>
                        <div class="note fr">
                            <a class="sign_password_2" href="javascript:;"><span>短信验证码登录</span></a>
                        </div>
                    </div>
                </div>
            </form>
            <!--登录表单-e-->
        </div>
    </div>

    <!--第三方登陆-s-->
    <div class="thirdlogin" style="margin-bottom: 3rem;">
        <h4>第三方登陆</h4>
        <ul>
            <tpshop sql="select * from __PREFIX__plugin where type='login' AND status = 1" item="v" key="k">
                <!--<if condition="$v['code'] eq 'weixin' AND is_weixin() neq 1">-->
                    <!--<li>-->
                        <!--<a class="ta-qq" href="{:U('LoginApi/login',array('oauth'=>'weixin'))}" target="_blank" title="WeChat">-->
                            <!--<div class="icon">-->
                                <!--<img src="__STATIC__/images/sign_in/wechat_1.png" />-->
                            <!--</div>-->
                        <!--</a>-->
                    <!--</li>-->
                <!--</if>-->
                <if condition="$v['code'] eq 'qq' AND is_qq() neq 1">
                    <li>
                        <a class="ta-qq" href="{:U('LoginApi/login',array('oauth'=>'qq'))}" target="_blank" title="QQ">
                            <div class="icon">
                                <img src="__STATIC__/images/sign_in/qq_1.png" />
                            </div>
                        </a>
                    </li>
                </if>
                <if condition="$v['code'] eq 'alipay' AND is_alipay() neq 1 AND is_weixin() neq 1">
                    <li>
                        <a href="{:U('LoginApi/login',array('oauth'=>'alipay'))}">
                            <div class="icon">
                                <img src="__STATIC__/images/sign_in/alipay_1.png"/>
                            </div>
                        </a>
                    </li>
                </if>
                <if condition="$v['code'] eq 'alipaynew' AND is_alipay() neq 1 AND is_weixin() neq 1">
                    <li>
                        <a href="alipays://platformapi/startapp?appId=20000067&url={$alipay_url}">
                            <div class="icon">
                                <img src="__STATIC__/images/sign_in/alipay_1.png"/>
                            </div>
                        </a>
                    </li>
                </if>
            </tpshop>
        </ul>
    </div>
    <!--第三方登陆-e-->
    <!-- 提示弹窗 -->
    <div class="alter-shoucan-1">
        <div class="alter-an">
            <div class="p-1">
                <p></p>
            </div>
        </div>
    </div>
          
<script src="__STATIC__/js/style.js" type="text/javascript" charset="utf-8"></script>
<!-- 登录流程一 -->
<script>
    $('.sign_password').on('click',function(){
        $('.loginsingup-input').eq(1).show().siblings('.loginsingup-input').hide();
    })
    function verify(){
        $('#verify_code_img').attr('src','/index.php?m=Mobile&c=User&a=verify&r='+Math.random());
    }
    function submitverify()
    {
        var type='phone';
        var username = $.trim($('#username').val());  //手机号码
        var mobile_code = $.trim($('#mobile_code').val()); //验证码
        var referurl = $('#referurl').val();
        var nub = 0;
        if(username == ''){
            $('#username').after(after_msg('用户名不能为空!'))
            $('#username').siblings('.z_tipi_1').eq(0).show().siblings('.z_tipi_1').remove();
            $('#username').addClass('asd_color')
            nub = 1;
        } 
        if(!(username == '') && !checkMobile(username) && !checkEmail(username)){
            $('#username').after(after_msg('账号格式不匹配!'))
            $('#username').siblings('.z_tipi_1').eq(0).show().siblings('.z_tipi_1').remove();
            $('#username').addClass('asd_color')
            nub = 1;
        }
        var codeExist = $('#mobile_code').length;
        if (codeExist && mobile_code == ''){
            $('#mobile_code').after(after_msg('验证码不能为空!'))
            $('#mobile_code').siblings('.z_tipi_1').eq(0).show().siblings('.z_tipi_1').remove();
            $('#mobile_code').addClass('asd_color')
            nub = 1;
        }
        var data = {username:username,code:mobile_code,send:username,type:type,scene:6,referurl:encodeURIComponent(referurl)};
        if(nub == 1){
            return false;
        }
        $.ajax({
            type : 'post',
            url : '/index.php?m=Mobile&c=User&a=do_login&t='+Math.random(),
            data : data,
            dataType : 'json',
            success : function(res){
                if(res.status == 1){
                    var url = decodeURIComponent(data.referurl);
                    if (url.indexOf('User') >= 0 && url.indexOf('login') >= 0 || url == '') {
                        window.location.href = '/index.php/mobile/';
                    }
                    window.location.href = url;
                }else{
                    alter_ab(res.msg);
                    if (codeExist) {
                        verify();
                    } else {
                        location.reload();
                    }
                }
            },
            error : function(XMLHttpRequest, textStatus, errorThrown) {
                alter_ab('网络失败，请刷新页面后重试');
            }
        })
    }


    function countdown(obj) {
        var s =  {$tpshop_config['sms_sms_time_out']|default=60};
        //改变按钮状态
        $(obj).attr('id','sendcode');
        callback();
        //循环定时器
        var T = window.setInterval(callback,1000);
        function callback()
        {
            if(s <= 0){
                //移除定时器
                window.clearInterval(T);
                $(obj).removeAttr('id');
                obj.innerHTML='获取短信验证码';
            }else{
                if(s<=10){
                    obj.innerHTML = '0'+ --s + '秒后再获取';
                }else{
                    obj.innerHTML = --s+ '秒后再获取';
                }
            }
        }
    }

    //发送短信验证码
    function sendcode(obj){
        var username = $.trim($('#username').val());  //手机号码
        var verify_code = $.trim($('#verify_code').val()); //验证码
        var nub = 0;
        if(username == ''){
            $('#username').after(after_msg('用户名不能为空!'))
            $('#username').siblings('.z_tipi_1').eq(0).show().siblings('.z_tipi_1').remove();
            $('#username').addClass('asd_color')
            nub = 1;
        } 
        if(!(username == '') && !checkMobile(username) && !checkEmail(username)){
            $('#username').after(after_msg('账号格式不匹配!'))
            $('#username').siblings('.z_tipi_1').eq(0).show().siblings('.z_tipi_1').remove();
            $('#username').addClass('asd_color')
            nub = 1;
        }
        if(nub == 1){
            return false;
        }
        if(nub == 0){
            $.ajax({
                url:'/index.php?m=Home&c=Api&a=send_validate_code&t='+Math.random() ,
                type:'post',
                dataType:'json',
                data:{type:$(obj).attr('rel'),send:$.trim($('#username').val()), scene:6},
                success:function(res){
                    if(res.status==1){
                        //成功;
                        alter_ab(res.msg)
                        countdown(obj)
                    }else{
                        //失败
                        alter_ab(res.msg)
                    }
                },
                error:function(){
                    alter_ab('网络错误，请稍后再试')
                }
            })
        }else{
            alter_ab('请先填写完所有信息！')
        }

    }
   
  
</script>
<!-- 登录流程二 -->
<script>
    $('.sign_password_2').on('click',function(){
        $('.loginsingup-input').eq(0).show().siblings('.loginsingup-input').hide();
    })
    
    function submitverify2()
    {
        var username = $.trim($('#username_2').val());  //手机号码
        var password = $.trim($('#password').val());  //密码
        var verify_code = $.trim($('#verify_code_2').val());  //验证码
        var is_first = $.trim($('#is_first').val());//是否第一次登录 是否需要验证验证码
        var referurl = $('#referurl').val();
        var nub = 0;
        if(username == ''){
            $('#username_2').after(after_msg('用户名不能为空!'))
            $('#username_2').siblings('.z_tipi_1').eq(0).show().siblings('.z_tipi_1').remove();
            $('#username_2').addClass('asd_color')
            nub = 1;
        }
        if(!(username == '') && !checkMobile(username) && !checkEmail(username)){
            $('#username_2').after(after_msg('账号格式不匹配!'))
            $('#username_2').siblings('.z_tipi_1').eq(0).show().siblings('.z_tipi_1').remove();
            $('#username_2').addClass('asd_color')
            nub = 1;
        }
        if(password == ''){
            $('#password').after(after_msg('密码不能为空!'))
            $('#password').siblings('.z_tipi_1').eq(0).show().siblings('.z_tipi_1').remove();
            $('#password').addClass('asd_color')
            nub = 1;
        }
        var codeExist = $('#verify_code').length;
        if (verify_code == '' && is_first == 1){
            $('#verify_code_2').after(after_msg('验证码不能为空!'))
            $('#verify_code_2').siblings('.z_tipi_1').eq(0).show().siblings('.z_tipi_1').remove();
            $('#verify_code_2').addClass('asd_color')
            nub = 1;
        }
        var data = {username:username,password:password,referurl:encodeURIComponent(referurl)};
        if (codeExist) {
            data.verify_code = verify_code;
        }

        if(nub == 1){
            return false;
        }


        $.ajax({
            type : 'post',
            url : '/index.php?m=Mobile&c=User&a=do_login&t='+Math.random(),
            data : data,
            dataType : 'json',
            success : function(res){
                if(res.status == 1){
                    var url = decodeURIComponent(data.referurl);
                    if (url.indexOf('user') >= 0 && url.indexOf('login') >= 0 || url == '') {
                        window.location.href = '/index.php/mobile/User/index';
                    }
                    window.location.href = url;
                }else{
                    alter_ab(res.msg)
                    if (codeExist) {
                        verify();
                    } else {
                        location.reload();
                    }
                }
            },
            error : function(XMLHttpRequest, textStatus, errorThrown) {
                alter_ab('网络失败，请刷新页面后重试')
            }
        })
    }

    //复选框状态
    function remember(obj){
         var che= $(obj).attr("class");
        if ( che == 'che'){
            $('#remember').val(1);
        }else if(che == 'che check_t'){
            $('#remember').val(0);
        }
    }
    //切换密码框的状态
    $(function(){
        $('.loginsingup-input .lsu i').click(function(){
            $(this).toggleClass('eye');
            if ($(this).hasClass('eye')) { 
                $(this).siblings('input').attr('type','password')
            } else{
                $(this).siblings('input').attr('type','text')
            }
        });
    })
    /**
     * 提示弹窗
     * @param msg
     */
    // function showErrorMsg(msg){
    //     layer.open({content:msg,time:2});
    // }
    //添加输入框提示
    function after_msg(msg=''){
      var p = '<div class="z_tipi_1"><b></b><h1>' + msg + '</h1></div>';
      return p;
    }
    // 弹框提示
    function alter_ab(ele){
        $('.alter-shoucan-1').show();
        $('.alter-an').children('.p-1').children('p').text(ele);
        if(!$('.alter-shoucan-1').is(':hidden')){
            setTimeout(function(){
            $('.alter-shoucan-1').fadeOut();
            },2000);
        }
    }

    //去除输入表格提示
    $('input').keydown(function(){
　　　　 $(this).siblings('.z_tipi_1').remove();
		$(this).removeClass('asd_color');
　　});
    $('input').click(function(){
　　　　 $(this).siblings('.z_tipi_1').remove();
		$(this).removeClass('asd_color');
　　});
</script>
<script type="text/javascript">
   
</script>
</body>
</html>
